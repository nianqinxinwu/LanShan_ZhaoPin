# 章鱼外快 — 业务流程文档

> 本文档记录系统各核心业务的完整流程、页面跳转逻辑及关键判断条件，供开发与测试参照。

---

## 目录

1. [登录绑定流程](#1-登录绑定流程)
2. [角色切换流程](#2-角色切换流程)
3. [求职者（报名者）流程](#3-求职者报名者流程)
4. [发布者（企业）流程](#4-发布者企业流程)
5. [职位发布与管理流程](#5-职位发布与管理流程)
6. [任务发布与管理流程](#6-任务发布与管理流程)
7. [报名与应聘流程](#7-报名与应聘流程)
8. [派单与面试流程](#8-派单与面试流程)
9. [关键本地存储字段说明](#9-关键本地存储字段说明)
10. [发布职位 → 报名 → 选人录用 → 群聊沟通（端到端流程）](#10-发布职位--报名--选人录用--群聊沟通端到端流程)
11. [职位置顶功能流程](#11-职位置顶功能流程)

---

## 1. 登录绑定流程

### 1.1 流程总览

用户首次进入小程序时，系统通过微信静默授权自动创建用户记录并获取 token，但此时用户尚未完善资料（无头像、昵称、手机号），属于"未登录"状态。用户需在"我的"页面点击头像区域，完成**微信绑定 → 身份选择**两步后才算完成登录。

```
┌─────────────────────────────────────────────────────────────────┐
│                        登录绑定流程                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  "我的"页面 (user/index)                                        │
│       │                                                         │
│       ├─ isuser=false (未完善资料) ──→ bindwx?from=login        │
│       │                                    │                    │
│       │                              填写头像/昵称/手机号        │
│       │                                    │                    │
│       │                              保存成功                    │
│       │                                    │                    │
│       │                              loginrole (身份选择)        │
│       │                                    │                    │
│       │                         ┌──────────┴──────────┐         │
│       │                         │                     │         │
│       │                    选择"报名者"           选择"发布者"    │
│       │                    setUserRole(1)        setUserRole(2)  │
│       │                         │                checkFlag=1     │
│       │                         │                     │         │
│       │                    返回"我的"页面         有ctoken?       │
│       │                                          ├─ 是 → 验证   │
│       │                                          │   ├ 有效→企业中心│
│       │                                          │   └ 无效→企业登录│
│       │                                          └─ 否 → 企业登录│
│       │                                                         │
│       └─ isuser=true (已完善资料) ──→ bindwx (编辑资料模式)      │
│                                          │                      │
│                                     保存 → navigateBack         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 涉及页面

| 页面 | 路径 | 职责 |
|------|------|------|
| 我的 | `pages/user/index` | 入口，判断 `isuser` 决定跳转目标 |
| 微信绑定 | `pages/bindwx/index` | 填写头像、昵称、获取手机号 |
| 身份选择 | `pages/loginrole/index` | 选择"报名者"或"发布者" |
| 企业登录 | `pages/companylogin/index` | 企业账号密码登录 |
| 企业注册 | `pages/companyregister/index` | 新企业入驻填写资料 |
| 企业中心 | `pages/companycenter/index` | 发布者管理后台 |

### 1.3 判断条件

| 条件 | 含义 | 取值方式 |
|------|------|----------|
| `isuser` | 用户是否已完善资料 | 后端 `getUserinit()` 根据 `avatarUrl` 是否为空判断 |
| `user_role` | 用户身份角色 | 后端 `user_role` 字段：0=未选择, 1=报名者, 2=发布者 |
| `ctoken` | 企业登录令牌 | `wx.getStorageSync('ctoken')`，企业登录成功后写入 |
| `checkFlag` | 项目展示模式 | 0=招聘模式, 1=章鱼外快模式 |

### 1.4 后端接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `v1.Sysinit/getUserinit` | POST | 返回用户信息，含 `isuser`、`user_role` |
| `v1.Sysinit/updateUser` | POST | 保存头像、昵称、手机号 |
| `v1.Login/setUserRole` | POST | 设置 `user_role`（1 或 2） |
| `v1.Login/getUserRole` | POST | 获取当前 `user_role` |
| `v1.Login/checkBind` | POST | 检查手机号是否已绑定 |

### 1.5 详细场景

**场景 A：新用户 → 报名者**

1. 打开小程序，系统静默获取微信 token，创建用户记录
2. 进入"我的"页面，`isuser=false`（无头像）
3. 点击头像区域 → 跳转 `bindwx?from=login`
4. 上传头像、输入昵称、授权手机号 → 点击保存
5. 保存成功 → `redirectTo` 到 `loginrole`
6. 选择"报名者" → 调用 `setUserRole(1)` → `redirectTo` 回"我的"页面
7. 页面刷新，`isuser=true`，展示报名者视图

**场景 B：新用户 → 发布者（无企业账号）**

1. 步骤 1-5 同场景 A
2. 选择"发布者" → 调用 `setUserRole(2)` + 设置 `checkFlag=1`
3. 无 `ctoken` → `redirectTo` 到 `companylogin`
4. 无账号 → 点击"注册" → `companyregister` 填写企业资料
5. 提交审核 → 后端自动设置 `user_role=2`
6. 审核通过后 → 回到 `companylogin` 用账号密码登录
7. 登录成功 → 存储 `ctoken` + `checkFlag=1` → 进入企业中心

**场景 C：新用户 → 发布者（已有企业账号）**

1. 步骤 1-5 同场景 A
2. 选择"发布者" → 调用 `setUserRole(2)` + 设置 `checkFlag=1`
3. 无 `ctoken` → `redirectTo` 到 `companylogin`
4. 输入账号密码登录成功 → 存储 `ctoken` → 进入企业中心

**场景 D：已登录用户编辑资料**

1. "我的"页面 `isuser=true`
2. 点击头像 → 跳转 `bindwx`（无 `from` 参数）
3. 修改信息 → 保存 → `navigateBack` 回"我的"页面

---

## 2. 角色切换流程

角色切换页面 (`switchrole/index`) 是底部 Tab 栏"发布"按钮的入口，与登录身份选择页 (`loginrole`) 是两个独立页面。

```
底部Tab"发布"按钮 → switchrole/index
    │
    ├─ 点击"我是求职者" → checkBind
    │   ├─ 已绑定 → mynote (简历中心)
    │   └─ 未绑定 → register (注册)
    │
    └─ 点击"我是企业" → checkBind
        ├─ 已绑定 → 检查ctoken
        │   ├─ 有ctoken → checkLogin
        │   │   ├─ 有效 → companycenter
        │   │   └─ 无效 → companylogin
        │   └─ 无ctoken → companylogin
        └─ 未绑定 → register (注册)
```

> `switchrole` 侧重于"发布"功能入口的角色分流，`loginrole` 侧重于首次登录时的身份选择与持久化。两者互不影响。

---

## 3. 求职者（报名者）流程

### 3.1 浏览职位

```
首页 (index) → 找工作 (findjob)
    │
    ├─ 筛选条件：区域、类别、结算方式、薪资范围、性别、排序
    ├─ 下拉刷新 / 上拉加载更多
    │
    └─ 点击职位卡片 → zwjobdetail (职位详情)
         │
         ├─ 报名 → checkBind
         │   ├─ 已绑定 → 提交报名 (sendJob)
         │   └─ 未绑定 → register
         │
         ├─ 收藏 → jobSave (切换收藏状态)
         │
         └─ 联系企业 → 聊天页面
```

### 3.2 简历管理

```
我的 → 我的简历 (mynote)
    │
    ├─ 填写：姓名、手机、生日、学历、工作经验、期望薪资...
    ├─ 上传个人照片
    │
    └─ 提交 → nextedu (完善教育经历)
```

### 3.3 我的功能入口

| 入口 | 页面 | 说明 |
|------|------|------|
| 我的报名 | `myfind` | 查看已报名的职位 |
| 我的收藏 | `mysave` | 已收藏的职位列表 |
| 我的关注 | `mygz` | 已关注的企业 |
| 我的评价 | `mycomment` | 查看已完成工作的评价 |
| 被查看记录 | `mylooknote` | 简历被查看记录 |
| 消息中心 | `sysmsg` | 系统通知 |

---

## 4. 发布者（企业）流程

### 4.1 企业注册

```
companyregister
    │
    ├─ 填写企业信息：名称、行业、类型、规模
    ├─ 选择地址：地图选点 (QQMap) + 城市区域
    ├─ 填写联系人：姓名、电话
    ├─ 设置登录账号：账号名 + 密码
    ├─ 上传图片：Logo (1张) + 营业执照 (1+张) + 相关资质 (1+张)
    │
    └─ 提交 → Savecompany → 后端设置 user_role=2
         │
         └─ 等待管理员审核 → 审核通过后可登录
```

### 4.2 企业登录

```
companylogin
    │
    ├─ 输入账号 + 密码 → doLogin
    │   ├─ 账号审核中 → 提示"审核中"
    │   ├─ 账号不存在 → 提示"请先入驻"
    │   └─ 登录成功 → 存ctoken + checkFlag=1 → companycenter
    │
    └─ 点击"注册" → companyregister
```

### 4.3 企业中心

```
companycenter
    │
    ├─ 企业信息：名称、Logo、会员等级
    ├─ 数据统计：职位数、收到简历数、置顶数、推广数、章鱼币余额
    │
    ├─ 管理入口：
    │   ├─ 编辑企业资料 → editcompany
    │   ├─ 管理职位 → companyjob
    │   ├─ 收到的简历 → companynote
    │   ├─ 管理任务 → mytasklist
    │   ├─ 聊天管理 → companychat
    │   ├─ 活动管理 → active
    │   ├─ 充值 → mymoney
    │   └─ 升级套餐 → companyrole
    │
    └─ 退出登录 → 清除ctoken → companylogin
```

---

## 5. 职位发布与管理流程

### 5.1 发布职位

```
企业中心 → 发布职位 (addcompanyjob)
    │
    ├─ 填写职位信息：
    │   ├─ 标题、分类、薪资档位、招聘人数
    │   ├─ 要求：学历、经验、年龄、性别
    │   ├─ 福利：五险一金、奖金、包吃住等 (多选)
    │   ├─ 结算方式：面议/日结/周结/月结/完工结
    │   ├─ 工作类型：全职/兼职
    │   └─ 职位描述 (富文本编辑器)
    │
    └─ 提交 (需ctoken验证) → Savejob → navigateBack
```

### 5.2 管理职位

```
企业中心 → 我的职位 (companyjob)
    │
    ├─ 职位列表（按状态筛选：全部/上架/下架）
    │
    ├─ 编辑 → editcompanyjob
    ├─ 上架/下架 → upJob / cancleJob
    └─ 置顶 → topJob (消耗置顶额度)
```

---

## 6. 任务发布与管理流程

任务（Task）是面向推荐人的悬赏模式：企业发布任务，推荐人成功推荐人选可获得奖励。

```
企业中心 → 管理任务 (mytasklist)
    │
    ├─ 查看已发布的任务列表
    │
    └─ 新增任务 (addtask)
         │
         ├─ 选择关联职位 (从企业已有职位中选)
         ├─ 任务标题、悬赏金额、需求人数
         ├─ 任务描述 (富文本)
         │
         └─ 提交 → Savetask → tasklist
```

---

## 7. 报名与应聘流程

```
求职者视角：
    职位详情 → 点击"报名" → checkBind
        ├─ 未绑定 → register (完善手机号)
        └─ 已绑定 → sendJob (提交报名)
             │
             └─ 报名成功 → 等待企业查看

企业视角：
    企业中心 → 收到的简历 (companynote)
        │
        └─ 查看报名者简历 → 决定是否邀请面试
```

---

## 8. 派单与面试流程

```
企业中心 → 派遣订单 (sendorder)
    │
    ├─ 筛选：全部(-1) / 待处理(0) / 已面试(1) / 已录用(2) / 已拒绝(3) / 已完成(4)
    │
    ├─ 查看报名者详情 → sendorderdetail
    │   ├─ 邀请面试 → Invitenote (状态变更)
    │   ├─ 同意录用 → doAgree
    │   ├─ 拒绝 → doAgree (拒绝)
    │   └─ 评价 → setcomment (工作完成后)
    │
    └─ 分页加载 (上拉加载更多)
```

---

## 9. 关键本地存储字段说明

| 字段 | 类型 | 说明 | 写入时机 |
|------|------|------|----------|
| `ctoken` | string | 企业登录令牌 | 企业登录成功时 |
| `checkFlag` | number | 项目展示模式：0=招聘, 1=章鱼外快 | 企业登录/身份选择时 |
| `user_role` | number | 用户身份：0=未选择, 1=报名者, 2=发布者 | 身份选择时，后端同步 |
| `cityinfo` | object | 当前城市 `{id, name}` | 首页定位/切换城市时 |
| `city` | string | 当前城市名称 | 首页定位/切换城市时 |
| `tid` | string | 任务推荐来源 ID | 扫码/分享链接进入时 |
| `rectid` | string | 招聘推荐来源 ID | 扫码/分享链接进入时 |
| `userInfo` | object | 微信用户基本信息 | 微信授权时 |

> **`checkFlag` 与 `user_role` 的区别**：`checkFlag` 控制前端 UI 展示模式（招聘项目 vs 章鱼外快项目），`user_role` 标识用户的业务身份（报名者 vs 发布者），两者是独立字段，互不替代。

---

## 10. 发布职位 → 报名 → 选人录用 → 群聊沟通（端到端流程）

本节梳理从职位发布到线上沟通的完整业务链路，涵盖前端页面、后端接口、数据库变更及状态流转。

### 10.1 发布职位

**角色**：企业发布者

**页面**：`wxapp/pages/zwaddjob/index`

**表单字段**：

| 字段 | 说明 | 必填 |
|------|------|------|
| jobtitle | 岗位名称 | 是 |
| type | 工作性质（全职/兼职等） | 是 |
| jobcatename | 行业分类（餐饮服务、活动执行等） | 是 |
| num | 招聘人数 | 是 |
| money | 薪资（如 300-600元/天） | 否 |
| settle_type | 结算方式（日结/周结/月结/完工结/面议） | 否 |
| sex | 性别要求（0不限/1男/2女） | 否 |
| content | 工作内容 | 是 |
| requirements | 工作要求 | 否 |
| tips | 温馨提示 | 否 |
| benefit_tag1/2 | 福利标签 | 否 |
| job_address | 工作地址 | 否 |
| job_lat/job_lng | 地址坐标 | 否 |
| work_start_date/work_end_date | 工作日期范围 | 否 |
| work_start_time/work_end_time | 每日工作时段 | 否 |

**接口**：

```
POST v1.Job/zwSaveJob
参数：上述表单字段 + ctoken（企业 token）+ companyid
```

**后端处理**：

1. 验证企业 token，确认企业信息完整（companyname 不为空）
2. 对 jobtitle、content、requirements、tips 进行敏感词过滤
3. 写入 `fa_zpwxsys_job` 表，status=0（待审核），ischeck=0
4. 扣减企业剩余可发布职位数（CompanyRecord 记录 jobnum=-1）

**审核上架**：管理员在后台（`fSVtCuiJPW.php` → 职位管理）设置 `ischeck=1` + `status=1` 后职位上架。

**职位状态**：

| status | 含义 |
|--------|------|
| 0 | 待审核 |
| 1 | 已发布（上架中） |
| -1 | 已下架 |

---

### 10.2 求职者报名

**角色**：求职者

**页面**：`wxapp/pages/zwjobdetail/index`（职位详情）→ 点击"报名" → `wxapp/pages/baoming/index`（报名表单）

**表单字段**：

| 字段 | 说明 | 必填 |
|------|------|------|
| name | 姓名 | 是 |
| sex | 性别（1男/2女） | 是 |
| tel | 手机号（中国大陆格式校验） | 是 |

**接口**：

```
POST v1.Baoming/saveBaoming
参数：jobid + name + sex + tel + cityid
```

**后端处理**：

1. **查重**：检查同一用户是否已报名过该职位（uid + jobid），重复则返回"您的信息已提交过"
2. **写入报名表**：`fa_zpwxsys_baoming` 存储报名者基本信息
3. **写入应聘记录表**：`fa_zpwxsys_jobrecord`，status=0（新提交）
4. **群聊通知**：如果该职位已有群聊，发送群内系统消息："张三 报名了岗位「服务员」"
5. **系统通知**：给企业发布者发送系统消息（`fa_zpwxsys_sysmsg`），附带跳转链接 `/pages/selectnote/index?jobid=X`

**数据库变更**：

| 表 | 操作 |
|----|------|
| `fa_zpwxsys_baoming` | INSERT 报名记录 |
| `fa_zpwxsys_jobrecord` | INSERT 应聘记录（status=0） |
| `fa_zpwxsys_chat_message` | INSERT 群内系统消息（如果群已存在） |
| `fa_zpwxsys_sysmsg` | INSERT 企业系统通知 |

---

### 10.3 发布者筛选录用

**角色**：企业发布者

**页面**：`wxapp/pages/selectnote/index?jobid=X`（筛选报名者）

发布者可通过系统通知中的链接直接进入，也可从企业后台的职位列表进入。

#### 10.3.1 加载报名者列表

**接口**：

```
POST v1.Company/companyNote
参数：ctoken + jobid + filterStatus（-1表示全部）+ page
```

**后端处理**：

- JOIN 查询 jobrecord + note + user + job + comment 表
- 返回报名者列表（姓名、头像、性别、年龄、学历、评分）+ 岗位信息（标题、工作时间段、需要人数）
- 已处理的报名者（status ≥ 1）标记为 disabled

**页面展示**：

```
┌──────────────────────────────────────────┐
│ 「XX岗位」报名表                          │
│ 2026/01/01-2026/02/28 8:00-17:00        │
│ 报名 x 人 / 需要 x 人                    │
├──────────────────────────────────────────┤
│ ☐ [头像] 张三  ★★★★☆  男  25岁  本科    │
│ ☐ [头像] 李四  ★★★☆☆  女  22岁  大专    │
│ ■ [头像] 王五  ★★☆☆☆  男  28岁  高中 已选│  ← 灰色不可选
├──────────────────────────────────────────┤
│              [ 选择 x 人 ]                │
└──────────────────────────────────────────┘
```

- 列表按评分从高到低排序
- 支持单选、全选
- 已录用者（status ≥ 1）灰色行 + "已选"标签，不可重复勾选

#### 10.3.2 确认选择

点击"选择 X 人"按钮后弹窗提示：

> 确认选择 X 人？选中的报名者将被录用，同时将消耗2章鱼币创建岗位群聊，已录用的报名者将自动加入群聊

确认后依次执行两个接口调用：

#### 10.3.3 批量录用

**接口**：

```
POST v1.Company/batchApplicant
参数：ctoken + ids=1,2,3（逗号分隔的 jobrecord ID）+ action=accept
```

**后端处理**：

1. 逐条遍历 ids
2. 跳过已处理记录（status ≥ 1，防止重复提交）
3. 更新 jobrecord status → 1（录用）
4. 如果该职位已有群聊：
   - 检查该用户是否已在群内
   - 不在则加入群（role=0 普通成员）
   - 发送群内系统消息："XX 已被录用，加入了群聊"

#### 10.3.4 自动创建群聊

**接口**：

```
POST v1.Coin/consume
参数：amount=2 + action=creategroup + related_id=jobid
```

**后端处理**：

1. 检查该职位是否已有群聊
   - 已有 → 直接返回 groupid，**不扣币**
   - 没有 → 继续
2. 扣除 2 章鱼币
3. 创建群组（`fa_zpwxsys_chat_group`）：
   - group_name = "{岗位名称}通知群"
   - owner_uid = 发布者 uid
   - status = 1
   - expire_time = 职位截止时间 +1 天 或 30 天后
4. 添加群主为成员（role=2）
5. 发送欢迎系统消息
6. 查询该职位所有已录用的报名者（jobrecord status=1），自动加入群（role=0）

**失败处理**：章鱼币不足时弹窗提示，引导发布者去"购买服务"页面充值后手动创建群聊。

---

### 10.4 群聊沟通

**角色**：发布者（群主）+ 已录用的报名者（群成员）

**页面**：

| 页面 | 路径 | 说明 |
|------|------|------|
| 我的群聊列表 | `wxapp/pages/mychatlist/index` | 展示用户加入的所有群聊 |
| 聊天室 | `wxapp/pages/chatroom/index?groupid=X` | 消息收发 |
| 群组管理 | `wxapp/pages/chatmanage/index?groupid=X` | 成员管理、公告等 |
| 群聊公约 | `wxapp/pages/chatrule/index?groupid=X` | 查看并同意公约 |

#### 10.4.1 消息展示

每条消息包含：

- 发送人头像
- 发送人昵称
- 角色标签（群主 / 管理员）
- 消息内容（文字 / 图片 / 系统通知）
- 发送时间

**消息类型**：

| msg_type | 类型 | 说明 |
|----------|------|------|
| 0 | 文字消息 | 用户发送的普通文字 |
| 1 | 系统消息 | 录用通知、公告更新、入群提示等 |
| 2 | 图片消息 | 用户发送的图片 |

#### 10.4.2 发送消息

**接口**：

```
POST v1.Chat/send
参数：groupid + content + msg_type（默认0）+ img_url（图片消息时）
```

**后端校验**：

1. 验证群成员身份
2. 检查是否已同意群聊公约（agreed_rule=1）
3. 检查禁言状态（is_muted）
4. 检查群状态（status=1 有效）
5. 文字消息：不允许连续 3 位及以上数字 + 敏感词过滤

发送成功后返回完整消息数据（msgItem），前端立即追加到消息列表展示，无需等待轮询。

#### 10.4.3 消息拉取

- 首次加载：`v1.Chat/messages`（lastId=0），获取最近 30 条历史消息
- 增量拉取：传入 lastId，获取新消息
- 当前采用 3 秒轮询方式（WebSocket 未配置时的回退方案）

#### 10.4.4 群组管理（群主/管理员可用）

**顶部操作栏**（role ≥ 1 可见）：

- "群组管理" → 进入 chatmanage 页面
- "候选人管理" → 进入 selectnote 页面（仅关联职位时显示）

**管理接口**：

| 接口 | 说明 |
|------|------|
| `v1.Chat/editNotice` | 编辑群公告 |
| `v1.Chat/memberList` | 查看群成员列表 |
| `v1.Chat/muteMember` | 禁言/解禁成员 |
| `v1.Chat/kickMember` | 踢出成员 |
| `v1.Chat/addMember` | 手动加人 |

#### 10.4.5 群聊公约

新成员入群后需同意群聊公约才能发言：

- 查看公约：`v1.Chat/getRule`
- 同意公约：`v1.Chat/agreeRule`（更新 agreed_rule=1）

---

### 10.5 Jobrecord 状态流转

```
0 (新提交/待处理)
├→  1 (录用/同意)  →  自动加入群聊
├→ -1 (拒绝)
└→  5 (签退/完工)
```

> 后续还有 status=2~6 及对应负值状态用于面试、试用、分佣等扩展场景。

---

### 10.6 完整时序图

```
发布者                      系统                       求职者
  │                          │                          │
  │── 发布职位 ────────────→ │                          │
  │                          │── job 写入 (status=0)    │
  │                          │                          │
  │                 [管理员审核通过]                      │
  │                          │── job (status=1,ischeck=1)│
  │                          │                          │
  │                          │                          │── 浏览职位
  │                          │                          │── 点击报名
  │                          │                          │── 填写信息提交
  │                          │                          │
  │                          │── baoming 写入            │
  │                          │── jobrecord 写入(status=0)│
  │                          │── sysmsg 通知发布者        │
  │                          │── 群内通知（如有群）        │
  │                          │                          │
  │── 收到系统通知 ←──────── │                          │
  │── 进入"筛选报名者"页面    │                          │
  │── 勾选报名者              │                          │
  │── 确认选择                │                          │
  │                          │                          │
  │                          │── jobrecord (status→1)    │
  │                          │── 扣 2 章鱼币             │
  │                          │── 创建群聊                │
  │                          │── 群主入群 (role=2)       │
  │                          │── 拉入已录用者 (role=0)   │
  │                          │                          │
  │── 在群聊中沟通 ←────────→ │ ←────────────────────→  │── 在群聊中沟通
  │   （安排工作、发通知等）    │                          │  （确认工作细节）
```

---

### 10.7 核心数据表

| 表名 | 用途 | 关键字段 |
|------|------|----------|
| `fa_zpwxsys_job` | 职位信息 | id, companyid, jobtitle, status, ischeck, num |
| `fa_zpwxsys_baoming` | 报名表单 | uid, jobid, name, sex, tel |
| `fa_zpwxsys_jobrecord` | 应聘记录（核心流转表） | uid, jobid, companyid, status |
| `fa_zpwxsys_chat_group` | 群聊 | id, jobid, owner_uid, status, member_count |
| `fa_zpwxsys_chat_member` | 群成员 | groupid, uid, role(0普通/1管理/2群主), agreed_rule, is_muted |
| `fa_zpwxsys_chat_message` | 群消息 | groupid, uid, content, msg_type(0文字/1系统/2图片) |
| `fa_zpwxsys_coinrecord` | 章鱼币消费记录 | uid, amount, action, related_id |
| `fa_zpwxsys_sysmsg` | 系统通知 | uid, content, link, status(0未读/1已读) |
| `fa_zpwxsys_note` | 求职者简历 | uid, name, sex, birthday, education, avatarUrl |
| `fa_zpwxsys_comment` | 用户评价 | uid, score（用于计算报名者平均评分） |
| `fa_zpwxsys_company` | 企业信息 | id, companyname, uid |
| `fa_zpwxsys_companyrecord` | 企业配额记录 | companyid, jobnum, notenum |

---

### 10.8 已知限制

1. **职位审核**：依赖管理员在后台手动操作 ischeck + status，无自动审核或审核通知机制
2. **消息实时性**：WebSocket 未配置，群聊消息通过 3 秒轮询拉取
3. **群聊付费**：创建群聊需 2 章鱼币，余额不足则无法建群，但录用操作本身不受影响
4. **系统通知**：报名时给发布者发送了 sysmsg，小程序端需有消息列表页展示入口

---

## 11. 职位置顶功能流程

### 11.1 功能概述

发布者可为已上架的职位购买置顶服务，置顶后职位在列表中优先展示并带有"置顶"角标，单次置顶持续 **24 小时**。

### 11.2 数据库设计

**表**：`fa_zpwxsys_job`

| 字段 | 类型 | 说明 |
|------|------|------|
| `toptime` | bigint(16) | 置顶到期时间（UNIX 时间戳）。0 或 ≤ 当前时间 = 未置顶；> 当前时间 = 置顶中 |

**表**：`fa_zpwxsys_companyrecord`

| 字段 | 类型 | 说明 |
|------|------|------|
| `totaltopnum` | int | 企业剩余置顶次数配额 |

### 11.3 置顶操作流程

```
发布者                          系统                           前端展示
  │                              │                              │
  │── companyjob 页面            │                              │
  │   点击"置顶"按钮             │                              │
  │                              │                              │
  │── 弹窗确认 ──────────────→   │                              │
  │   "您的操作将会消耗置顶1次？" │                              │
  │                              │                              │
  │── 确认 ──────────────────→   │                              │
  │                              │                              │
  │   POST v1.Company/topJob     │                              │
  │   参数: ctoken, id(jobid)    │                              │
  │                              │                              │
  │                              │── ① 验证企业 token            │
  │                              │── ② 查询 job.toptime          │
  │                              │                              │
  │                              │── toptime < time() ?          │
  │                              │   │                          │
  │                              │   ├─ 是（未置顶/已到期）      │
  │                              │   │   │                      │
  │                              │   │   ├─ 查询 totaltopnum    │
  │                              │   │   │                      │
  │                              │   │   ├─ topnum > 0 ?        │
  │                              │   │   │   │                  │
  │                              │   │   │   ├─ 是              │
  │                              │   │   │   │  toptime =       │
  │                              │   │   │   │  time()+86400    │
  │                              │   │   │   │  topnum -= 1     │
  │                              │   │   │   │  → "置顶成功"     │
  │                              │   │   │   │                  │
  │                              │   │   │   └─ 否              │
  │                              │   │   │      → "置顶次数余额不足"│
  │                              │   │   │                      │
  │                              │   └─ 否（置顶中）             │
  │                              │       → "当前置顶未结束"      │
  │                              │                              │
  │                              │                              │── 岗位列表刷新
  │                              │                              │   toptime > time()
  │                              │                              │   → is_top=1
  │                              │                              │   → 显示"置顶"角标
```

### 11.4 涉及页面

| 页面 | 路径 | 职责 |
|------|------|------|
| 我的职位 | `pages/companyjob/index` | 职位列表，包含"置顶"按钮 |
| 购买服务 | `pages/buyservice/index` | 章鱼币购买置顶服务（备选入口） |
| 首页 | `pages/index/index` | 展示置顶角标 |
| 找工作 | `pages/findjob/index` | 展示置顶角标 |

### 11.5 后端接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `v1.Company/topJob` | POST | 消耗置顶次数，设置 toptime = 当前时间 + 24h |

### 11.6 前端展示逻辑

**岗位列表查询时**（Job Model 的 `getJobByWhere` / `getNearJobByWhere`）：

```php
if ($v['toptime'] > time()) {
    $joblist[$k]['toptime'] = '置顶中';
    $joblist[$k]['is_top'] = 1;
} else {
    $joblist[$k]['toptime'] = '未置顶';
    $joblist[$k]['is_top'] = 0;
}
```

**列表页分两次查询**：
1. 置顶职位：`j.toptime > time()`，排在前面
2. 普通职位：`j.toptime < time()`，排在后面

**前端角标**（wxml）：

```xml
<view class="job-card-top" wx:if="{{item.is_top == 1}}">置顶</view>
```

### 11.7 付费方式

| 方式 | 扣费 | 入口 |
|------|------|------|
| 配额消耗 | 企业 `totaltopnum` 减 1 | companyjob 页面"置顶"按钮 |
| 章鱼币购买 | 10 章鱼币 / 24 小时 | buyservice 页面"置顶服务"选项 |

### 11.8 业务规则

1. **时长**：每次置顶持续 24 小时（86400 秒）
2. **不可叠加**：置顶未到期时不允许重复置顶，返回"当前置顶未结束"
3. **自动失效**：到期后 `toptime ≤ time()`，自动恢复为普通职位，无需定时任务
4. **仅限上架职位**：置顶按钮在 companyjob 列表中可见，逻辑上只有已发布的职位才有置顶意义
