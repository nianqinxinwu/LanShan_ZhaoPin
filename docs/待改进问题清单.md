# 待改进问题清单

## 一、签到流程断点问题（严重）

### 1.1 问题描述

当前系统存在两套录用流程：

- **原始流程**（全职招聘设计）：发布者逐人操作，经历 4 步状态变更
- **简化流程**（兼职/外快场景）：发布者在 selectnote 页面批量选人录用

简化流程中 `batchApplicant(action=accept)` 只将 jobrecord 状态设为 **1（同意面试）**，但工人签到要求 `status=4`，中间缺少 3 步状态推进，导致通过简化流程录用的工人**无法签到**。

### 1.2 状态流转全图

```
状态码   含义           触发方法                     操作方
──────────────────────────────────────────────────────────────
  0    新提交          工人报名时自动创建               工人
  1    同意面试        Company::doAgree()              发布者
                      Company::batchApplicant()        发布者
 -1    拒绝面试        Company::doAgree()              发布者
                      Company::batchApplicant()        发布者
  2    面试成功        Company::doInvatePass()          发布者
 -2    面试失败        Company::doInvatePass()          发布者
  3    录用成功        Company::doInvateTypein()        发布者
 -3    录用失败        Company::doInvateTypein()        发布者
  4    试用成功        Job::confirmWork()               工人
 -4    试用失败        Company::doInvateTry()           发布者
  5    已完成          Job::doSignOut()                  工人
  6    已评价          工人提交评价                      工人
```

### 1.3 原始流程（可正常签到）

```
工人报名 → status=0
    ↓ doAgree(status=1)              发布者同意面试
status=1（同意面试）
    ↓ doInvatePass(status=2)         发布者标记面试通过
status=2（面试成功）
    ↓ doInvateTypein(status=3)       发布者标记录用成功
status=3（录用成功）
    ↓ confirmWork()                  工人点击「工作确认」
status=4（试用成功/已确认）
    ↓ doSignIn()                     工人点击「我要签到」→ signed_in=1
status=4, signed_in=1
    ↓ doSignOut()                    工人点击「我要签退」
status=5（已完成）
    ↓
status=6（已评价）                    工人提交评价
```

### 1.4 简化流程（签到不可达）

```
工人报名 → status=0
    ↓ batchApplicant(accept)         发布者批量选人
status=1（同意面试）
    ↓ ？？？                         ← 无入口推进到 status=2
    ↓ ？？？                         ← 无入口推进到 status=3
    ↓ confirmWork 要求 status=3      ← 工人看不到「工作确认」按钮
    ↓ doSignIn 要求 status=4         ← 工人无法签到
    ✗ 流程中断
```

### 1.5 工人端按钮显示逻辑

工人在"求职管理"页面（`myfind/index`）看到的操作按钮由 status 决定：

| 条件 | 显示按钮 | 文件位置 |
|------|----------|----------|
| `status == 3` | 工作确认 | `myfind/index.wxml:63` |
| `status == 4 && !signed_in` | 我要签到 | `myfind/index.wxml:64` |
| `status == 4 && signed_in` | 我要签退 | `myfind/index.wxml:65` |
| `status == 5` | 去评价 | `myfind/index.wxml:66` |

当 status=1 时，工人端不显示任何操作按钮，流程卡住。

### 1.6 涉及文件

| 文件 | 位置 | 说明 |
|------|------|------|
| `addons/zpwxsys/controller/v1/Company.php` | `batchApplicant()` 行2607 | 批量选人，设 status=1 |
| `addons/zpwxsys/controller/v1/Company.php` | `doAgree()` 行493 | 同意/拒绝面试，设 status=1/-1 |
| `addons/zpwxsys/controller/v1/Company.php` | `doInvatePass()` 行581 | 面试通过/失败，设 status=2/-2 |
| `addons/zpwxsys/controller/v1/Company.php` | `doInvateTypein()` 行673 | 录用成功/失败，设 status=3/-3 |
| `addons/zpwxsys/controller/v1/Company.php` | `doInvateTry()` 行767 | 试用成功/失败（原始流程） |
| `addons/zpwxsys/controller/v1/Job.php` | `confirmWork()` 行1247 | 工人工作确认，要求 status=3，设为4 |
| `addons/zpwxsys/controller/v1/Job.php` | `doSignIn()` 行1274 | 工人签到，要求 status=4 |
| `addons/zpwxsys/controller/v1/Job.php` | `doSignOut()` 行1455 | 工人签退，要求 status=4，设为5 |
| `addons/zpwxsys/wxapp/pages/myfind/index.wxml` | 行63-66 | 工人端按钮显示条件 |
| `addons/zpwxsys/wxapp/pages/selectnote/index.js` | `confirmSelect()` | 简化版选人录用入口 |

### 1.7 建议修改方案

**方案一（推荐）**：简化流程中 `batchApplicant` 将 status 直接设为 3（录用成功），跳过面试环节。工人可直接看到「工作确认」按钮，正常进入签到流程。

**方案二**：简化流程中 `batchApplicant` 将 status 直接设为 4（试用成功），跳过面试和工作确认环节，工人可直接签到。

**方案三**：在 selectnote 简化页面增加中间状态推进按钮，让发布者手动推进。

方案一最合理，既保留了工人主动确认开始工作的环节（有契约意义），又跳过了兼职场景不需要的面试阶段。

---

## 二、签到表功能已修复的问题

以下问题已在本轮修复中解决：

### 2.1 `u.wechaname` 字段不存在（已修复）

- **问题**：`Company.php:2806` 的签到详情查询使用了 `u.wechaname`，但 `fa_zpwxsys_user` 表中没有此字段（只有 `nickname`），导致进入签到详情页 500 错误
- **修复**：后端改为 `u.nickname`，前端 `signindetail/index.wxml` 改为 `item.nickname`
- **修复文件**：`Company.php:2806`、`signindetail/index.wxml:20`

### 2.2 签到详情显示未录用的报名者（已修复）

- **问题**：`getSigninDetail()` 查询未过滤 `r.status`，导致待处理（status=0）和已拒绝（status=-1）的报名者也出现在签到表中
- **修复**：添加 `$rmap['r.status'] = ['>=', 1]` 过滤条件
- **修复文件**：`Company.php:2803`

### 2.3 分页跳过第一条记录（已修复）

- **问题**：`limit($Nowpage, $limits)` 中 `$Nowpage` 被重置为 1，导致始终跳过第一条记录
- **修复**：改为 `limit(0, $limits)`
- **修复文件**：`Company.php:2730`、`Company.php:2809`

---

## 三、签到功能补充建议

### 3.1 发布者端当前能力

签到表功能目前为**纯查看**模式：

- 签到列表页（`signinlist`）：展示各岗位签到概况（报名/签到/签退人数）
- 签到详情页（`signindetail`）：展示某岗位每位工人的签到/签退时间和工时

### 3.2 可补充功能

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 发布者手动签到/签退 | P1 | 当工人忘记操作时，发布者可代为签到/签退 |
| 考勤数据导出 | P2 | 导出 Excel/CSV 考勤表 |
| 签到提醒推送 | P2 | 工作日自动推送签到提醒给工人 |
| 地理位置校验 | P3 | 签到时验证工人是否在工作地点附近 |
| 二维码签到 | P3 | 发布者展示二维码，工人扫码签到 |

---

## 四、其他已知遗留问题

### 4.1 `doInvatePass` 通知条件错误

- **文件**：`Company.php:601`
- **问题**：`doInvatePass()` 方法处理"面试通过/失败"，但通知发送的 IF 条件检查的是 `$param['status'] == 1 || == -1`，应该检查 `2 / -2`
- **影响**：面试通过/失败时不会发送系统通知给工人

### 4.2 `batchApplicant` 入群通知中的 `wechaname`

- **文件**：`Company.php:2663`
- **问题**：`$userInfo['wechaname']` 引用了不存在的字段
- **影响**：录用入群系统通知中用户名可能显示为 `新成员`
- **建议**：改为 `$userInfo['nickname'] ?: '新成员'`
