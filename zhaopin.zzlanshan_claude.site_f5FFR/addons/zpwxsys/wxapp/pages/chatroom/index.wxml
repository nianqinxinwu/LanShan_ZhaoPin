<view class="container">

  <!-- 顶部操作栏 -->
  <view class="top-bar" wx:if="{{member.role >= 1}}">
    <view class="top-bar-btn manage" wx:if="{{member.role >= 1}}" bindtap="toManage">群组管理</view>
    <view class="top-bar-btn" wx:if="{{group.jobid}}" bindtap="toSelectNote">候选人管理</view>
  </view>

  <!-- 群公告 -->
  <view class="notice-bar" wx:if="{{group.notice}}" bindtap="showNotice">
    <text class="notice-label">公告</text>
    <text class="notice-text">{{group.notice}}</text>
  </view>

  <!-- 消息列表 -->
  <scroll-view class="msg-list" scroll-y scroll-into-view="{{scrollToMsg}}" scroll-with-animation>
    <view class="msg-loading" wx:if="{{loading && msglist.length == 0}}">
      <view class="loading-dot"></view>
      <text>正在加载消息</text>
    </view>

    <view wx:for="{{msglist}}" wx:key="id" id="msg-{{item.id}}" class="msg-item {{item.msg_type == 1 ? 'system' : (item.is_self ? 'self' : 'other')}}">

      <!-- 系统消息 -->
      <view wx:if="{{item.msg_type == 1}}" class="system-msg">
        <text>{{item.content}}</text>
      </view>

      <!-- 普通消息 -->
      <block wx:else>
        <image wx:if="{{!item.is_self}}" class="msg-avatar" src="{{item.avatarUrl || '../../imgs/icon/nodata.png'}}"></image>
        <view class="msg-body">
          <view class="msg-name-bar">
            <text class="msg-name">{{item.name}}</text>
            <text wx:if="{{item.role == 2}}" class="role-tag owner">群主</text>
            <text wx:elif="{{item.role == 1}}" class="role-tag admin">管理员</text>
          </view>
          <view class="msg-bubble {{item.msg_type == 2 ? 'img-bubble' : ''}}">
            <block wx:if="{{item.msg_type == 2}}">
              <image class="msg-img" src="{{item.img_url}}" mode="widthFix"
                     bindtap="previewImage" data-url="{{item.img_url}}" />
            </block>
            <block wx:else>
              <text>{{item.content}}</text>
            </block>
          </view>
          <view class="msg-time">{{item.time_str}}</view>
        </view>
        <image wx:if="{{item.is_self}}" class="msg-avatar" src="{{item.avatarUrl || '../../imgs/icon/nodata.png'}}"></image>
      </block>
    </view>

    <view class="msg-empty" wx:if="{{!loading && msglist.length == 0}}">
      <text>暂无消息，发一条开始聊天吧</text>
    </view>
  </scroll-view>

  <!-- 公约未同意提示 -->
  <view class="rule-tip" wx:if="{{member.agreed_rule != 1}}">
    <text>请先同意群聊公约才能发言</text>
    <view class="rule-btn" bindtap="toRule">查看公约</view>
  </view>

  <!-- 禁言提示 -->
  <view class="mute-tip" wx:elif="{{member.is_muted == 1}}">
    <text>您已被禁言</text>
  </view>

  <!-- 输入区域 -->
  <view class="input-bar" wx:else>
    <view class="img-btn" bindtap="chooseImage">+</view>
    <input class="msg-input" placeholder="输入消息..." value="{{inputValue}}" bindinput="onInput" bindconfirm="doSend" confirm-type="send" />
    <view class="send-btn" bindtap="doSend">发送</view>
  </view>

</view>
