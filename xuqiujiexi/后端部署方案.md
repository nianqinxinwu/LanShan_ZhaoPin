# 章鱼外快 — 后端代码部署方案

## 一、服务器环境信息

| 项目 | 值 |
|------|-----|
| 生产域名 | `fastadmin.site100.cn` |
| 服务器IP | `122.51.106.231`（腾讯云） |
| 数据库 | MySQL 3306，同机部署（应用内通过 127.0.0.1 连接） |
| Web服务器 | Apache（.htaccess URL Rewrite） |
| PHP版本 | 7.4+ |
| 框架 | ThinkPHP 5 + FastAdmin |
| 项目根目录（推测） | `/www/wwwroot/fastadmin.site100.cn/` 或 `/var/www/zhaopin/` |
| API入口 | `https://fastadmin.site100.cn/addons/zpwxsys/` |

> **注意**：项目当前无 Git 仓库、无 CI/CD、无自动化部署脚本，需手动上传文件。

---

## 二、本次需要部署的文件清单

以下文件相对于项目根目录 `zhaopin.zzlanshan_claude.site_f5FFR/`：

| 文件路径 | 改动内容 |
|----------|----------|
| `addons/zpwxsys/controller/v1/Job.php` | 敏感词过滤、名片校验、发布审核、auditJob 接口 |
| `addons/zpwxsys/model/Job.php` | is_top 标志、settle_type 字段查询 |

数据库变更（已执行完毕，无需重复）：
- `ALTER TABLE fa_zpwxsys_job ADD COLUMN settle_type ...` — 已于 2026-02-19 执行

---

## 三、部署方式

### 方式A：SCP 命令行直传（推荐）

适用场景：有服务器 SSH 账号密码或密钥。

```bash
# 假设服务器用户名为 root，项目目录为 /www/wwwroot/fastadmin.site100.cn/
# 请根据实际情况修改 用户名、服务器路径

# 1. 上传 Job 控制器
scp addons/zpwxsys/controller/v1/Job.php \
  root@122.51.106.231:/www/wwwroot/fastadmin.site100.cn/addons/zpwxsys/controller/v1/Job.php

# 2. 上传 Job 模型
scp addons/zpwxsys/model/Job.php \
  root@122.51.106.231:/www/wwwroot/fastadmin.site100.cn/addons/zpwxsys/model/Job.php
```

上传后建议清除 ThinkPHP 运行时缓存：

```bash
ssh root@122.51.106.231 "rm -rf /www/wwwroot/fastadmin.site100.cn/runtime/cache/* && rm -rf /www/wwwroot/fastadmin.site100.cn/runtime/temp/*"
```

### 方式B：SFTP 图形化工具

适用场景：不熟悉命令行，用可视化工具操作。

**推荐工具**：
- macOS：Transmit、Cyberduck（免费）、FileZilla
- 跨平台：FileZilla、WinSCP（Windows）

**步骤**：
1. 打开 SFTP 工具，新建连接：
   - 协议：SFTP（不是 FTP）
   - 主机：`122.51.106.231`
   - 端口：`22`
   - 用户名/密码：服务器 SSH 账号
2. 连接后导航到服务器项目目录（如 `/www/wwwroot/fastadmin.site100.cn/`）
3. 将本地以下文件拖拽覆盖到对应路径：
   - `addons/zpwxsys/controller/v1/Job.php`
   - `addons/zpwxsys/model/Job.php`
4. 覆盖前建议先备份服务器上的旧文件（右键 → 重命名为 `Job.php.bak`）

### 方式C：宝塔面板（如果服务器装了宝塔）

腾讯云服务器常装宝塔面板，可通过浏览器操作：

1. 浏览器访问 `http://122.51.106.231:8888`（宝塔默认端口，可能不同）
2. 登录后进入 **文件** 管理器
3. 导航到 `addons/zpwxsys/controller/v1/`，上传覆盖 `Job.php`
4. 导航到 `addons/zpwxsys/model/`，上传覆盖 `Job.php`
5. 在 **终端** 中执行清除缓存命令（见方式A）

---

## 四、部署后验证

### 4.1 快速验证接口可用

在浏览器或终端访问一个公开接口，确认服务正常：

```bash
curl -s "https://fastadmin.site100.cn/addons/zpwxsys/v1.Job/getJoblist" | head -c 200
```

应返回 JSON 格式数据（`{"status":...}`），而非 500 错误页。

### 4.2 验证 settle_type 字段返回

```bash
curl -s "https://fastadmin.site100.cn/addons/zpwxsys/v1.Job/getJoblist" | python3 -m json.tool | grep settle_type
```

如果返回结果中包含 `"settle_type": 0`，说明 model 改动已生效。

### 4.3 在微信开发者工具中测试

1. 打开微信开发者工具，导入 `addons/zpwxsys/wxapp/` 目录
2. 测试以下功能：
   - **发布职位**：填写表单 → 选择结算方式 → 提交 → 应提示"发布成功，等待审核"
   - **职位列表**：置顶职位应显示红色"置顶"角标
   - **职位卡片**：有视频的职位应显示播放图标
   - **职位详情**：薪资旁应显示结算方式（日结/周结等）

---

## 五、回滚方案

如果部署后出现问题：

```bash
# 如果之前做了备份
ssh root@122.51.106.231 "cd /www/wwwroot/fastadmin.site100.cn/addons/zpwxsys/ && \
  cp controller/v1/Job.php.bak controller/v1/Job.php && \
  cp model/Job.php.bak model/Job.php"
```

数据库 `settle_type` 字段无需回滚，它有默认值 0，不影响旧逻辑。

---

## 六、长期部署建议

当前项目没有版本控制和自动化部署，随着改动增多，手动传文件容易出错遗漏。建议逐步建立：

### 6.1 第一步：初始化 Git 仓库

```bash
cd zhaopin.zzlanshan_claude.site_f5FFR/
git init
echo "runtime/" >> .gitignore
echo "vendor/" >> .gitignore
echo ".env" >> .gitignore
git add -A
git commit -m "初始化版本控制"
```

在服务器端同样初始化 Git 仓库，后续通过 `git pull` 部署。

### 6.2 第二步：编写部署脚本

在项目根目录创建 `deploy.sh`：

```bash
#!/bin/bash
# 使用方法: ./deploy.sh

SERVER="root@122.51.106.231"
REMOTE_DIR="/www/wwwroot/fastadmin.site100.cn"

echo "开始部署..."

# 同步变更文件（排除运行时和配置文件）
rsync -avz --exclude='runtime/' \
           --exclude='.env' \
           --exclude='vendor/' \
           --exclude='node_modules/' \
           --exclude='wxapp/' \
           ./ ${SERVER}:${REMOTE_DIR}/

# 清除缓存
ssh ${SERVER} "rm -rf ${REMOTE_DIR}/runtime/cache/* ${REMOTE_DIR}/runtime/temp/*"

echo "部署完成"
```

### 6.3 第三步（可选）：搭配 Git Hooks 自动部署

在服务器上配置 `post-receive` 钩子，本地 `git push` 后自动更新代码，实现半自动化部署。

---

## 附录：项目目录结构（部署相关）

```
zhaopin.zzlanshan_claude.site_f5FFR/
├── addons/zpwxsys/          ← 核心业务代码（需部署）
│   ├── controller/v1/       ← API 控制器
│   ├── model/               ← 数据模型
│   ├── service/             ← 服务层
│   ├── validate/            ← 验证器
│   ├── config.php           ← 微信配置（含密钥，谨慎处理）
│   └── wxapp/               ← 小程序前端（不部署到服务器）
├── application/             ← ThinkPHP 应用层（需部署）
├── public/                  ← Web 入口（需部署）
├── thinkphp/                ← 框架核心（已部署，一般不动）
├── vendor/                  ← Composer 依赖（服务器上 composer install）
├── runtime/                 ← 运行时缓存（不部署，服务器自动生成）
└── .env                     ← 环境配置（不部署，服务器单独配置）
```
